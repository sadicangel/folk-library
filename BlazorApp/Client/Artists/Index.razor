@page "/artists"
@using FolkLibrary.Albums;
@using FolkLibrary.Services;
@using FolkLibrary.Tracks;
@inject ICountryInfoProvider CountryInfo
@inject ArtistStateProvider State

<PageTitle>FolkLibrary - Artists</PageTitle>

<MudTable Items="@State.Artists" @bind-SelectedItem="@selectedArtist" OnRowClick="@((TableRowClickEventArgs<ArtistDto> e) => OpenDrawer())" Height="100%" Filter="@Filter" Hover="true" Breakpoint="Breakpoint.Sm" FixedHeader="true" FixedFooter="true" Loading="@(!State.Artists.Any())" LoadingProgressColor="Color.Info">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Artists</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ArtistDto, object>(x => SortBy(x, nameof(ArtistDto.ShortName)))">Name</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ArtistDto, object>(x => SortBy(x, nameof(ArtistDto.Name)))">Full Name</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ArtistDto, object>(x => SortBy(x, nameof(ArtistDto.Year)))">Year</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ArtistDto, object>(x => SortBy(x, nameof(ArtistDto.Country)))">Country</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ArtistDto, object>(x => SortBy(x, nameof(ArtistDto.Location)))">Location</MudTableSortLabel></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Avatar"><MudAvatar Color="Color.Tertiary">@context.LetterAvatar</MudAvatar></MudTd>
        <MudTd DataLabel="Name">@context.ShortName</MudTd>
        <MudTd DataLabel="FullName">@context.Name</MudTd>
        <MudTd DataLabel="Year">@context.YearString</MudTd>
        <MudTd DataLabel="Country"><MudImage Height="24" Src="@GetCountryImageUrl(context.Country)" Alt="@CountryInfo.GetCountryName(context.Country)" /></MudTd>
        <MudTd DataLabel="Location">@context.Location</MudTd>
    </RowTemplate>
</MudTable>


<MudDrawer @bind-Open="@isOpen" Anchor="Anchor.End" Width="35%" Elevation="1" Variant="@DrawerVariant.Temporary">
    @if (selectedArtist is not null)
    {
        <MudCard>
            <MudCardHeader>
                <CardHeaderAvatar>
                    <MudAvatar>@selectedArtist.LetterAvatar</MudAvatar>
                </CardHeaderAvatar>
                <CardHeaderContent>
                    <MudText Typo="Typo.h5">@selectedArtist.ShortName</MudText>
                    <MudText Typo="Typo.body1">@selectedArtist.Name</MudText>
                </CardHeaderContent>
            </MudCardHeader>
        </MudCard>
        <MudCardMedia Image="https://picsum.photos/250?blur" Height="250" />
        <MudCardContent>
            @if (selectedArtist.Description is not null)
            {
                <MudText Typo="Typo.body2">This photo was taken in a small village in Istra Croatia.</MudText>
            }
            <MudText Typo="Typo.body1">Albums</MudText>
            <MudTreeView T="string" ExpandOnClick="true">
                @foreach (var album in selectedArtist.Albums.OrderBy(a => a.IsCompilation ? 1 : 0).ThenBy(a => a.Year ?? Int32.MaxValue).ThenBy(a => a.Name))
                {
                    <MudTreeViewItem Value="@album.Name" Icon="@(album.IsCompilation ? Icons.Material.Filled.Label : Icons.Material.Filled.LabelImportant)" IconColor="@(album.IsCompilation ? Color.Primary : Color.Secondary)">
                        @foreach (var track in album.Tracks.OrderBy(t => t.Number))
                        {
                            <MudTreeViewItem Value="@($"{track.Number:D2} {track.Name} ({track.Duration:mm\\:ss}) {(album.TracksContributedByArtist?.Contains(track.Number) ?? false? "\U0001F5F8" : "")}")" />
                        }
                    </MudTreeViewItem>
                }
            </MudTreeView>
        </MudCardContent>
        <MudCardActions>
            <MudIconButton Icon="@Icons.Material.Filled.Favorite" Color="Color.Default" />
            <MudIconButton Icon="@Icons.Material.Filled.Share" Color="Color.Default" />
        </MudCardActions>
    }
</MudDrawer>

@code {
    private string searchString = "";
    private bool isOpen = false;
    private ArtistDto selectedArtist = null!;

    protected override async Task OnInitializedAsync()
    {
        await State.FetchPageAsync(1, 200);
    }

    private async Task<TableData<ArtistDto>> FetchDataAsync(TableState state)
    {
        return new TableData<ArtistDto>
            {
                Items = await State.FetchPageAsync(state.Page)
            };
    }

    private bool Filter(ArtistDto artist)
    {
        if (String.IsNullOrWhiteSpace(searchString))
            return true;
        if (artist.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (artist.ShortName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (artist.Country.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (artist.Location.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    private object SortBy(ArtistDto artist, string property)
    {
        switch (property)
        {
            case nameof(ArtistDto.ShortName):
                return artist.ShortName;
            case nameof(ArtistDto.Name):
                return artist.Name;
            case nameof(ArtistDto.Year):
                return artist.Year ?? Int32.MaxValue;
            case nameof(ArtistDto.Country):
                return artist.Country;
            case nameof(ArtistDto.Location):
                return artist.Location;
            default:
                return artist.Year ?? Int32.MaxValue;
        }
    }

    private void OpenDrawer()
    {
        isOpen = true;
    }

    private static string GetCountryImageUrl(string country)
    {
        return $"/flags/{country.ToLowerInvariant()}.png";
    }

    private static string GetHslColor(string str)
    {
        var hash = Math.Abs(str.GetHashCode());
        var h = (hash % (0 - 360)) + 0;
        var s = (hash % (50 - 75)) + 50;
        var l = (hash % (25 - 60)) + 25;
        return $"hsl({h}, {s}%, {l}%)";
    }
}